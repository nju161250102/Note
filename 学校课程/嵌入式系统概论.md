# 嵌入式系统概论

## 1 嵌入式系统概述
### 1.1 嵌入式系统的定义  
* IEEE（国际电气和电子工程师协会）的定义：  
嵌入式系统是用于控制、监视或者辅助操作机器和设备的装置  
* 普遍被认同的定义：  
嵌入式系统是以应用为中心，以计算机技术为基础，软硬件可裁减，适⽤用于应用系统对功能、可靠性、成本、体积、功耗有严格要求的专用计算机系统。
* 其他定义
    * 包含有计算机，但又不是通用计算机的计算机应用系统
    * 看不见的计算机，一般不能被用户编程, 它有⼀些专用的I/O设备, 对用户的接口是应用专用的
* 嵌入式系统三要素：
    * 嵌入性：嵌入到对象体系中，有对象环境要求
    * 专用性：软、硬件按对象要求设计、裁减
    * 计算机：实现对象的智能化功能

### 1.2 嵌入式系统的组成
* 硬件：  
微处理器为核心集成存储器和系统专用的输入/输出设备  
* 软件：  
初始化代码及驱动、嵌入式操作系统和应用程序等，有机地结合形成系统特定的一体化软件  

### 1.3 嵌入式系统的特点
* 形式多样、面向特定应用
* 处理器和处理器体系结构类型多
* 关注成本
* 实时性和可靠性的要求
* 适应多种处理器、可剪裁、轻量型、实时可靠、可固化的嵌入式操作系统
* 开发需要专门工具和特殊方法

### 1.4 嵌入式系统的分类
* 按嵌入式处理器的位数来分类
* 按应用来分类
* 按速度分类
* 按确定性来分类
* 按嵌入式系统软件复杂程度来分类

### 1.5 嵌入式系统安全
数据存储不安全、服务端控制措施部署不当、传输过程中没有加密、身份认证措施不当、密钥保护措施不当、会话处理不当、敏感数据泄漏

## 3 嵌入式系统设计
### 软硬件分工
软件部分：操作系统功能（任务调度、资源管理、设备驱动）、协议栈、应用程序框架。

双重性部分：算法、数学运算

硬软件设计的趋势——融合、渗透，对系统设计的影响——协同设计

## 4 4.	嵌入式硬件系统
### 4.2 存储器架构
#### 存储器组织
地址线、数据线、读写信号

#### RAM随机存储器
读写方便快捷，使用电信号完成读写操作；必须有直流电源供电，断电数据丢失。

* DRAM动态随机存储器：周期性刷新
* SRAM静态随机存储器：不用刷新，更快，密度更低

#### ROM只读存储器
数据不能改变，只能读取，ROM在工厂中被写入程序

#### Flash快闪存储器
非易失性存储器，随机读取，写入远比读取慢，块级操作

* NOR
* NAND

#### 存储器结构
* Flat single-space
* Segmented
* Bank-switched
* Multiple-space
* Virtual

## 5 嵌入式软件系统
### 嵌入式软件与桌面软件的对比
内存、CPU能力、操作系统、实时行为、开发流程、执行流程、工具组件、开发工具。

### 嵌入式软件如何影响硬件设计
#### 软件/硬件权衡
* 微处理器选择：对效率的影响
* 内存大小和组合
* ROM/RAM互相交换数据能力

#### 硬件调试
* 仿真器：使用不广泛
* 监视调试器：需要通讯通道和ROM/RAM交换能力
* 片上调试：需要板载连接器和ROM/RAM交换能力

#### 支持自检
* I/O电路：循环反馈
* 板载开关：用于配置和模式选择
* 状态显示：字符或者只是LED（三种状态：开，关，闪烁）

### 嵌入式软件架构
#### 嵌入式软件体系结构
* **驱动层**：板级初始化程序、与系统软件相关的驱动、与应用软件相关的驱动、与应用软件相关的驱动不一定需要与操作系统连接，这些驱动的设计和开发由应用决定。
* **操作系统层**：操作系统层包括嵌入式内核、嵌入式TCP/IP网络系统、嵌入式文件系统、嵌入式GUI系统和电源管理等部分。
* **中间件层**：主要包括嵌入式CORBA、嵌入式Java、嵌入式DCOM和面向应用领域的中间件软件。
* **应用层**：应用层软件主要由多个相对独立的应用任务组成。每个应用任务完成特定的工作，如I/O任务、计算的任务、通信任务等，由操作系统调度各个任务的运行

#### 为实时系统建立模型
* 单线程程序模型：快速简单、易修改 | 应用领域受限、安全性、不易移植
* 多线程程序模型：任务划分独立、并行、高吞吐量 | 资源竞争

#### 嵌入式软件体系结构概述
* 轮询：
  * 反复按顺序询问设备是否执行任务（高优先级任务可以增加询问次数）
* 状态机
  * 循环中根据状态决定需要执行的操作
  * 和轮询方式类似，但是只有当前状态被执行。每个状态决定了下一状态
* 带中断的轮询
  * 通过状态标记跳出循环执行任务
* 只有中断
  * 太多的ISR引发问题
  * 需要处理嵌套中断，否则时间长且优先级低的中断将被忽略
* 功能队列调度
  * 函数指针被添加至队列，由任务或中断添加
  * 主循环遍历队列并执行
* 实时操作系统

|架构|优先级|反应时间|变更的影响|易用性|
|:---|:---|:---|:---|:---|
|轮询|无（顺序执行）|所有任务总和|影响其他任务的执行时间|无数据共享问题|
|状态机|每个状态决定下个状态的优先度|所有任务总和|影响其他任务的执行时间|无数据共享问题|
|带中断的轮询|中断的优先级高于主循环|所有任务总和或者中断执行时间|对中断服务影响很小，其余相同|处理中断中的数据共享问题|
|仅中断|取决于中断的优先级|中断执行时间|几乎没有影响|处理中断中的数据共享问题|
|功能队列调度|中断具有优先级，任务执行无|最长任务的执行时间|很小|处理中断中的数据共享问题|

#### 实时操作系统
特征：可靠性、可预测性、性能、紧凑、可扩展性。实时操作系统中没有主循环，由调度程序决定应该运行哪一个任务。

* 就绪时间：进程准备就绪的时间
* 截止时间：进程必须完成的时间
  * 硬截止：如果错过系统出错
  * 软截止：用户可能会注意到，但是不会出错
* 发生周期：进程激活的间隔
* CPU利用率：正在做有效工作的CPU时间占比，假设没有调度开销
* 进程的三态
* 多任务操作系统、线程、任务控制块TCB

#### 线程调度
* 如何决定执行哪个线程：
  * 抢占式与非抢先式调度
  * 定期与非周期性任务
  * 固定优先级与动态优先级
  * 优先级倒置异常
  * 其他调度异常
* 如何评估调度策略：
  * 能够满足所有对时间的要求
  * CPU利用率
  * 调度开销
  * 延迟
  * 总完成时间 
* RMS调度（单调速率调度）：根据执行周期的长短来决定调度优先级
* EDF调度（最早截止时间调度）：根据任务的截止时间动态分配优先级
* 比较：RMS调度更简单，EDF可以实现CPU的完全利用

## 7 板级支持包与系统引导
### 嵌入式软件运行流程
* 上电复位
* 板级初始化：汇编语言实现，初始化堆栈指针寄存器、BSS段、CPU芯片级
* 引导/升级系统：根据需要进入不同阶段
* 系统初始化：初始化数据空间、接口外设、文件网络系统、中间件
* 应用初始化：信号量、消息队列
* 多任务应用：按照已确定的算法进行调度

### BSP 板级支持包
提供一段启动代码（类似BIOS，但功能区别很大），位于RTOS靠近传统硬件的部分。BSP中的驱动程序抽象物理设备或虚拟设备的功能软件，用于管理这些设备的操作。

BSP和BIOS/UEFI的区别：BIOS主要是负责在电脑开启时检测、初始化系统设备、装入操作系统并调度操作系统向硬件发出的指令。BSP和操作系统绑在⼀一起运行，还包含和系统相关的基本驱动。BIOS用户不能更改，只能对参数进行修改设置，BSP可以编程修改，添加和系统无关的驱动和程序。

BSP的特点和功能：硬件相关性、操作系统相关性。

### 嵌入式系统的初始化过程
* 片级初始化：CPU的初始化，从上电的初始状态逐步设置为系统要求的工作状态
* 板级初始化：CPU以外其他硬件设备的初始化，设置某些软件的数据结构和参数
* 系统级初始化：软件初始化为主，将操作权交给系统完成余下的初始化

### BootLoader
嵌入式系统中的OS启动加载程序，包括固件中的boot代码和Boot Loader两部分

嵌入式系统中引导加载程序：  
* 没有BIOS那样的固件程序
* 系统的加载启动任务完全由Boot Loader来执行
* 存储位置
* 复制过程

#### Boot Loader的生命周期
* 初始化硬件，如设置UART(至少设置一个)，检测存储器等
* 设置启动参数，告诉内核硬件的信息，如用哪个启动界面，波特率
* 跳转到操作系统的首地址
* 消亡

#### Boot Loader的操作模式
* 启动加载模式
* 下载模式

#### Boot Loader的调试
* 硬件调试
* 源码软件调试

## 8 模型