# 企业应用架构模式

### 引言

架构：高层次的系统分解；系统中不易改变的决定

企业应用：持久化数据；大量数据；并发访问；用户界面；应用集成；不一致的概念；复杂的业务逻辑

模式：根据实际情况选择、更改、优化合适的模式

### 1 分层

优点：减少依赖；标准化工作；面向接口

缺点：级联修改；运行效率下降

难点：决定建立哪些层次，以及每一层的职责

#### 1.2 三个基本层次

* 表现层：提供服务，显示信息，处理用户请求
* 领域层：逻辑
* 数据源层：与数据库、消息系统、事务管理器通信

选择合适的分离方式：子程序、类、包

领域层和数据源层绝对不要依赖于表现层

#### 1.3 为各层选择运行环境

数据源层通常运行在服务器端，领域逻辑则可以一分为二（提取出独立的模块？）

### 2 组织领域逻辑

* 事务脚本：从表示层获得输入、校验和计算处理、存储数据或调用其他系统的操作、组织整理返回值、返回给表示层。因此可以想象成一个动作或者业务事务的脚本。
  * 优点：简单易理解；与简单数据源层很好地协作；易于设定事务边界
  * 缺点：增加复杂性；难以复用
* 领域模型：面向对象方法，由对象承担相应逻辑。
  * 缺点：使用上的复杂性和映射到数据库的复杂
* 表模块：与记录集一起工作，只有一个公共的实例。
  * 优点：容易发现和移除冗余代码
  * 缺点：无法应用面向对象的设计模式

#### 2.1 抉择

复杂的领域逻辑选择领域模型，拥有基于记录集的工具选择表模块，三种模式并不互相排斥。

#### 2.2 服务层

置于领域模型或者表模块之上，提供清晰的API（根据用例组织），放置事务与安全性控制功能

### 3 映射到关系数据库

#### 3.1 架构模式

* 行数据入口：为返回的每一行产生一个实例（面向对象的方式看待数据）
* 表数据入口：以记录集模拟数据库的表格式属性
* 数据映射器：处理数据库与领域模型之间所有的存取操作

#### 3.2 行为问题

保证使用的数据库状态的一致性（同步问题）

工作单元：跟踪所有从数据库中读取的对象和以任何形式修改过的对象，排列复杂的数据库交互

#### 3.3 读取数据

* 接口模式决定何处放置查找器
* 最好创建独立的查找器变量
* 查找器方法工作在数据库状态下

简单的性能优化经验：

* 尽量一次返回多行
* 尽可能避免使用Join

#### 3.4 结构映射模式

外键映射：一对多关系

关联表映射：多对多关系

单表继承：为所有类建立一个表（属性冗余），表过大

具体表继承：为每个具体类建立一个表（属性重复），难以更改

类表继承：需要多个连接操作载入对象，损失性能

### 4 Web表现层

模型—视图—控制器：

* 控制器处理请求消息
* 模型负责领域逻辑
* 视图基于模型创建应答消息

#### 4.1 视图模式

* 模板视图：在网页结构中编写表示层，嵌入标签甚至代码
* 转换视图：XSLT
* 两步视图：提取出公用的基本视图，再创建细化的视图

#### 4.2 输入控制器模式

为每一个页面准备一个输入控制器。两种职责：处理HTTP请求消息，根据消息决定下一步做什么。